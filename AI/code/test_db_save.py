import asyncio
import json
from datetime import datetime, UTC
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from chatbot.database.models import Base, User, Medication, UserMedication
from chatbot.database.models import MedicationSummary

# SQLite 데이터베이스 URL
DATABASE_URL = "sqlite+aiosqlite:///test.db"

# 테스트용 샘플 데이터
sample_users = [
    {
        "id": 1, 
        "name": "김환자",
        "created_at": datetime.now(UTC)
    },
    {
        "id": 2, 
        "name": "이환자",
        "created_at": datetime.now(UTC)
    }
]

sample_medications = [
    {
        "id": 1,
        "name": "타이레놀",
        "details": json.dumps({
            "성분": "아세트아미노펜",
            "용법용량": "1회 1~2정씩 1일 3-4회 필요시 복용",
            "효능효과": "감기로 인한 발열 및 동통(통증), 두통, 신경통, 근육통, 월경통, 염좌통(삔 통증)"
        }),
        "dur_info": json.dumps({
            "주의사항": "간장애 또는 그 병력이 있는 환자",
            "이상반응": "쇼크, 아나필락시스 유사증상",
            "상호작용": "다른 해열진통제, 감기약과 병용 투여하지 않음"
        }),
        "created_at": datetime.now(UTC)
    },
    {
        "id": 2,
        "name": "판콜에스",
        "details": json.dumps({
            "성분": "아세트아미노펜, 클로르페니라민말레산염",
            "용법용량": "1회 2정씩 1일 3회 식후 복용",
            "효능효과": "감기의 제증상(콧물, 코막힘, 재채기, 인후통, 기침, 가래, 오한, 발열, 두통, 관절통, 근육통)의 완화"
        }),
        "dur_info": json.dumps({
            "주의사항": "다른 감기약, 해열진통제와 함께 복용하지 않음",
            "이상반응": "졸음, 어지러움, 구역, 구토",
            "상호작용": "MAO 억제제, 알코올"
        }),
        "created_at": datetime.now(UTC)
    },
    {
        "id": 3,
        "name": "리노에바스텔캡슐",
        "details": json.dumps({
            "성분": "Pseudoephedrine Hydrochloride 수도에페드린, Ebastine 에바스틴",
            "용법용량": '''○ 성인 : 1일 1회 1캡슐, 심한 경우 1일 2회 1캡슐 투여

○ 만 12세 이상 청소년 : 1일 1회 1캡슐
치료지속기간은 증상이 심한 경우에 한하며, 일반적으로 의사의 지시 없이는 혈관운동성, 알러지성 비염에서 10일 이상, 감기와 관련된 비염에서 3일 이상 지속하지 않아야 한다."''',
            "효능효과": "혈관운동성, 알러지성 비염 및 감기에 관련된 비염 증상의 치료"
        }),
        "dur_info": json.dumps({
            "주의사항": '''수도에페드린 함유 의약품 복용시 급성 전신성 발진성 농포증(AGEP)과 같은 중증 피부 이상반응이 나타날 수 있다. 환자들을 주의 깊게 모니터링해야 한다. 발열, 홍반, 다수의 작은 농포와 같은 증상이 관찰될 경우 이 약의 복용을 중단하고 적절한 조치를 취해야 한다.
2. 다음 환자에는 투여하지 말 것
1) 이 약의 주성분 및 첨가제 성분에 과민증이 있는 환자
2) 이 약은 수도에페드린이 함유되어 있으므로, 협우각성 녹내장, 뇨저류, 중증 고혈압, 관상부전, 갑상선기능항진증을 가진 환자 및 모노아민옥시다제 저해제(IMAO)로 치료받고 있는 환자 또는 2주간 치료를 받은 환자
3) 중증의 간장애 환자
4) 12세 이하의 어린이
5) 임부 또는 수유부
3. 다음의 환자에는 신중히 투여할 것
1) 녹내장
2) 고혈압
3) 심질환 환자
4) 당뇨병 (이 약은 백당 102.56mg을 함유하므로 특히 주의해야 한다.)
5) 전립선 비대증 환자
6) 간장애 또는 그 병력이 있는 환자 (간장애를 악화시키거나 재발시킬 수 있다.)
7) QT 연장을 일으키기 쉬운 환자 [저칼륨혈증, 저마그네슘혈증, 선천성 QT 연장 증후군, 투석중, 아스테미졸, 베프리딜, 시사프리드, 스파르플록사신, β차단제를 제외한 항부정맥약, 이뇨제, 정신병치료제 (페노치아진계, 부틸로페논계, 삼환계·사환계 항우울약 등), 프로부콜 등 QT 연장을 일으킬 수 있다고 알려져 있는 약물을 투여 중인 환자]
8) 간대사효소인 CYP3A4 효소를 억제하는 다음 약물을 복용 중인 환자
- 아졸계 항진균제 : 케토코나졸, 이트라코나졸
- 마크로라이드계 항생물질 : 에리스로마이신
9) 60세 이상의 노인의 경우 치료상의 유익성이 위험성을 상회한다고 판단되는 경우에만 신중히 투여한다. 60세 이상의 환자에게 과다 복용하면 환각, 중추신경계 기능 저하, 발작 및 사망에 이를 수 있다.
10) 중증 신장애 환자의 경우 치료상의 유익성이 위험성을 상회한다고 판단되는 경우에만 신중히 투여한다.

5. 일반적 주의
1) 대부분의 환자에서 이 약을 복용한 후 졸음을 경험하지 않았으나 졸음 또는 현기증이 발생할 수 있으므로 자동차 운전 혹은 위험한 기계조작 등 주의력을 집중시킬 필요가 있는 일에 종사하는 사람은 이 약에 대해 자신의 반응이 익숙할 때까지 주의할 필요가 있다.
2) 수도에페드린 성분과 관련하여 허혈성 대장염의 증상(급격한 복통, 직장 출혈 등)이 발현될 수 있다. 이 경우 이 약의 복용을 중단하고 전문가와 상담한다.
6. 임부 및 수유부에 대한 투여
1) 동물실험에서 기형발생 작용이 보고되어 있으며 태아의 성장지체, 언청이의 위험 등의 증가, 태아의 뇌성장 및 발달에도 영향을 끼칠 수 있으며 임신 중에 코르티코이드를 투여한 모체에서 태어난 신생아의 경우 부신부전증을 일으킬 수 있으므로 임부 또는 임신하고 있을 가능성이 있는 부인에게는 치료상의 유익성이 위험성을 상회한다고 판단되는 경우에만 투여한다.
2) 코르티코이드는 모유중으로 이행될 수 있으므로 이 약 투여 중에는 수유를 중단한다.
7. 소아에 대한 투여
1) 소아 및 청소년기에서 용량 관련 성장지체가 비가역적으로 나타날 수 있으므로 소아에 코르티코이드를 투여할 경우에는 최소용량을 투여해야 하며 발육성장에 관해 주의깊게 관찰한다.
2) 장기 투여한 경우 두개내압 항진증상이 나타날 수 있다.
8. 고령자에 대한 투여
고령자에 장기 투여한 경우, 감염증의 유발, 당뇨병, 골다공증, 고혈압, 후낭하 백내장, 녹내장 등의 부작용이 나타나기 쉬우므로 충분히 관찰하여 신중히 투여한다.
9. 의약품동등성시험 정보주1)

10. 기타
1) β2-효능제와 병용에 의해 저칼륨혈증이 나타날 수 있다.
2) 외국에서 사균 백신과 불활성화 백신의 효과가 감소되었다는 보고가 있다.
3) 코르티코이드의 투여로 피부시험반응이 억제될 수 있으므로 이 약 투여 중 피부시험을 할 때는 주의한다.
4) 외국에서 가뇌 종양이 나타난다는 보고가 있다.
5) 코르티코이드를 투여 받은 환자에서 카포시육종이 보고된 바 있다


            ''',
            "이상반응": '''1) 에바스틴 관련 이상반응
- 순환기계 : 드물게 심계항진이 나타날 수 있다.
- 정신신경계 : 졸음, 신경과민, 마비감, 무력증, 의기소침, 흥분, 때때로 권태감, 드물게 두통이 나타날 수 있다.
- 소화기계 : 구역, 구토, 복통, 위장장애 때때로 구갈, 위부불쾌감, 드물게 비ㆍ구강내건조, 설염, 설사, 변비가 나타날 수 있다.
- 간 : 때때로 AST·ALT, LDH, Al-P의 상승이 나타날 수 있다.
- 과민증 : 발진, 부종이 나타날 수 있다.
- 기타 : 경미한 체중증가, 호산구증다증, 흉부압박감, BUN 상승, 당뇨를 나타날 수 있다. 유사약(테르페나딘 등)에 의해 QT연장, 심실성 부정맥(토르사드 드 포인트 포함)이 나타났다는 보고가 있다.
2) 슈도에페드린 때문에 특히 교감신경흥분제의 과민증인 환자에서, 구강건조, 과민증, 흥분, 불면, 현기, 두통이 나타날 수 있고, 장기투여시 오심, 구토를 일으킬 수 있다. 또한 빈박, 동계를 일으킬 수 있다. 급성 전신성 발진성 농포증(AGEP), 발열, 홍반, 다수의 작은 농포와 같은 중증 피부 이상반응이 나타날 수 있다. 기타 다른 증상이 나타나면 의사와 상담해야 한다.
3)시판 후 사용 중에 아나필락시스쇼크가 보고되었다.

            ''',
            "상호작용": '''1) 이 약은 피부알러지시험을 방해할 수 있으므로 치료중단후 5-7일 후까지는 실시되어서는 안된다.
2) 이 약은 다른 항히스타민제와 효과를 증강시킬 수 있다.
3) 이 약은 모노아민옥시다제 저해제(IMAO) 병용 또는 복용 14일 이내 투여시, 카테콜아민 방출 증가(수도에페드린의 기능 상승)로 인한 심각한 혈관성 고혈압을 일으킬 수 있다. 또한, 다른 약물(메틸도파, 메카밀아민, 레세르핀, 맥각 알칼로이드)의 혈압강하효과를 감소시킬 수 있다.
4) 다른 교감신경흥분성 약물과의 병용투여는 상가효과를 일으키며, 독성을 증가시킬 수 있다. 유사하게 일부의 항고혈압제(베타-차단제)와 상호작용할 수 있다.
5) 이 약의 성분은 알코올의 효과를 증대시키지 않는다.
6) 이 약에 함유된 에바스틴을 에리스로마이신과 병용투여시, 에리스로마이신이 이 약의 대사를 억제하여 혈중 농도를 2배 상승 시켰다는 보고가 있다.
7) 이 약에 함유된 에바스틴을 케토코나졸 또는 에리스로마이신과 병용 투여시 케토코나졸 또는 에르스로마이신 단독투여 시 보다 QT 간격이 10msec 상승하는 것으로 보고되었다.
케토코나졸 또는 이트라코나졸과 같은 아졸계 항진균제 및 에리스로마이신과 같은 마크로라이드계 항생제를 병용투여하는 환자에게 에바스틴-수도에페드린을 투여할 때 주의해야 한다.
8) 이 약에 함유된 에바스틴을 리팜피신과 병용투여시 상호작용 할 수 있다.
9) 디기탈리스 배당체 및 흡입 마취제를 투여받는 환자에게 수도에페드린을 투여하면 부정맥의 위험이 증가할 수 있다.
7. 임부 및 수유부에 대한 투여
1) 임부 및 임신하고 있을 가능성이 있는 부인에 대한 안전성이 확립되어 있지 않으므로 치료상의 유익성이 위험성을 상회한다고 판단되는 경우에만 신중히 투여한다.
2) 동물실험(랫트)에서 이 약이 유즙으로 이행된다는 보고가 있으므로 이 약을 투여중에는 수유를 중단한다.
9. 보관 및 취급상의 주의사항
1) 어린이의 손이 닿지 않는 곳에 보관할 것
2) 다른 용기에 바꾸어 넣는 것은 사고원인이 되거나 품질 유지면에서 바람직하지 않으므로 이를 주의할 것","밀폐용기, 실온보관(1-30℃)"
8. 과량투여시의 처치
이 약의 과량투여의 경우 위장관 세척과 증상 치료 및 ECG를 포함한 활력징후 모니터링 등 생명을 유지하는데 필요한 치료를 긴급하게 시행해야 한다.

- 졸음이 올 수 있으므로 운전, 위험한 기계조작시 주의하세요.
- 전문가와 상의없이 다른 감기약과 병용하지 마세요.
- 고혈압 환자나 그 병력이 있는 경우 전문가에게 미리 알리세요
'''
        }),
        "created_at": datetime.now(UTC)
    },
    {
        "id": 4,
        "name": "프레디솔정",
        "details": json.dumps({
            "성분": "미결정셀룰로오스, 스테아르산마그네슘, 유당수화물",
            "용법용량": "",
            "효능효과": '''2. 류마티스성 장애
급성진행 또는 악화를 방지하기 위한 단기투여용 보조요법으로서 다음의 질환 : 외상 후 골관절염, 골관절염의 활막염, 연소성 류마티스양 관절염을 포함하는 류마티스양 관절염(경우에 따라서는 저용량 유지요법이 필요할 수도 있음), 급성 및 아급성 점액낭염, 상과염, 급성 비특이성 건초염, 급성 통풍성 관절염, 건선성 관절염, 강직성 척추염
3. 교원성 질환
악화 중에 있거나 유지요법이 필요한 다음의 질환 : 전신성 홍반성 루푸스(루푸스 신염), 전신성 피부근염(다발성 근염), 급성 류마티스성 심염
4. 피부 질환 : 천포창, 중증 다형성 홍반(스티븐스-존슨증후군), 박탈성 피부염, 수포성 포진양 피부염, 중증 지루성 피부염, 중증 건선, 균상식 육종
5. 알레르기성 질환
중증 또는 불능을 초래하는 알레르기성 질환으로서 일반적인 처치로는 반응이 없는 다음의 질환 : 기관지천식, 접촉성 피부염, 아토피성 피부염, 혈청병, 계절성 또는 다년성 알레르기성 비염, 약물과민반응
6. 안과 질환
중증 급만성 알레르기성 또는 염증성으로 눈 및 그 부속기관에 관련되는 다음의 질환 : 안대상포진, 홍채염 및 홍채모양체염, 맥락망막염, 후부의 산재성 포도막염 및 맥락막염, 시신경염, 교감신경성 안염, 전방의 염증, 알레르기성 결막염, 알레르기성 각막주위궤양, 각막염
7. 위장관계 질환
결정적 위기를 넘기기 위한 다음의 질환 : 궤양성 대장염, 국한성 장염
8. 호흡기계 질환 : 증후성 사르코이드증, 베릴륨 중독증, 전격성 또는 파종성인 폐결핵(적절한 항결핵 화학요법제와 병용투여), 다른 방법으로 낫지 않는 뢰플러 증후군, 흡인성 폐염
9. 혈액 질환 : 후천성(자가면역성) 용혈성 빈혈, 성인의 특발성 혈소판 감소성 자반증, 성인의 속발성 ]
혈소판 감소증, 적아구감소증(적혈구 빈혈), 선천성 적혈구 형성 부전성 빈혈
10. 악성 종양성 질환
다음 질환의 고식적 관리 : 소아의 급성 백혈병, 성인의 백혈병 및 임파종
11. 부종성 질환 : 요독 증상이 없는 특발성 신증후 또는 홍반성 루푸스로 인한 신증후에 있어서 배뇨증가의 유도 및 단백뇨의 완화
12. 신경계 질환 : 다발성 경화증의 급성악화
13. 기타 : 결핵성 수막염(지주막하의 차단상태 또는 차단이 우려되는 경우로서, 적절한 항결핵 화학요법제와 병용투여), 선모충증(신경성 또는 심근성 합병증이 수반된 경우)",,,,,,,,"1. 초기 복용량은 특정 질병의 증상에 따라 메칠프레드니솔론으로서 1일 4mg에서 48mg까지 다양할 수 있다. 일반적으로 심하지 않은 상태에서는 저용량으로 충분하나, 특별한 환자에서는 초기 고용량이 요구될 수도 있다. 초기 용량은 만족스러운 반응이 얻어질 때까지 유지되거나 조정되어야만 한다. 만약 합당한 기간 후에도 만족스러운 임상 결과가 없다면 투여를 중지하고 다른 적절한 치료로 전환하여야 한다. 용량은 치료하는 다양한 질병과 환자의 반응성에 따라 개별적으로 정하는 것이 필요하다. 적정반응이 나타난 후에는 적절한 임상반응을 유지할 수 있는 최소 용량이 될 때까지 알맞은 간격으로 초기용량을 감소시킴으로써 적절한 유지용량을 결정해야 한다. 용량에 관해서는 지속적인 모니터링이 요구된다. 질병의 경감이나 악화, 환자 개개인의 약물 반응성, 치료하는 질병의 증상과 직접적인 영향이 없는 스트레스를 가하는 환경에 노출되었을 때의 환자에 대한 영향이 있는 경우는 용량조절이 필요할 수 있는 상황에 포함된다. 후자의 경우에 있어서 환자의 상태에 만족스러울 만큼의 기간 동안 용량을 증가할 필요가 있을 수 있다.장기간 치료 후 약물의 중지시 천천히 감소하는 것이 요망된다.

2. 다발성 경화증(Multiple sclerosis)
다발성 경화증의 급성 악화의 치료는 1주일간 프레드니솔론 200mg을 매일 투여한 후 1달 동안 격일로 프레드니솔론 80mg을 투여하는 것이 효과적이다 (메칠프레드니솔론 4mg은 프레드니솔론 5mg과 같다).
3. ADT(Alternate Day Therapy :격일치료)
격일치료란 이틀 중 하루아침에 1일 용량의 2배를 투여하는 용법이다. 이 용법의 목적은 장기간 약물투여가 요구되는 환자에게 코르티코이드의 효과를 증대시키고, 뇌하수체-부신의 억제, 쿠싱양 상태(Cushingoid state), 코르티코이드 금단 증상과 소아의 성장 억제 등 부작용을 최소화하는데 있다.
이러한 치료계획의 이론은 다음 2가지 중요한 전제에 기초한다.
1) 코르티코이드의 항염증 효과와 치료 효과가 물리적인 존재와 대사효과보다 더욱 지속되고
2) 격일로 아침에 코르티코이드를 복용하는 것이 코르티코이드를 투여하지 않은 날 거의 정상적인 시상하부-뇌하수체-부신(Hypothalamus-pituitary-adrenal : HPA)활성의 재형성을 가져온다. HPA생리에 대한 간단한 요약은 이러한 이론적 해석의 이해를 도와줄 수 있다. 유리 코르티솔은 주로 시상하부를 통해 작용하므로 유리 코르티솔의 감소는 뇌하수체를 자극하여 부신피질자극호르몬(ACTH)의 생산을 증가시키는 반면, 유리 코르티솔의 상승은 ACTH분비를 억제한다. 정상적으로 HPA계는 24시간동안 활동리듬으로 특정 지워진다. ACTH의 혈청치는 오후 10시의 낮은 수준에서 오전 6시에 최고 수준으로 증가한다. ACTH의 증가 수준은 부신피질 활성을 자극하여 오전 2-8시 사이에 혈장 코르티솔을 최고로 증가시키게 한다. 코르티솔의 이런 증가는 ACTH 생성을 감소시키고 따라서 부신피질합성도 저하시킨다. 이것은 하루동안에 혈장 코르티코이드를 점차로 저하시켜 한밤중에는 최소수준으로 저하된다. HPA의 24시간 리듬축이 쿠싱질환(Cushing's disease)에서는 없어지는데, 이 질환은 구심성의 지방분포를 가진 비만, 쉽게 멍이 드는 얇은 피부, 약하고 근육이 줄어들고, 고혈압, 잠재성의 당뇨병, 골다공증, 전해질 불균형 등으로 특정 지워지는 부신피질과기능증의 증상이다. 같은 부신피질기능항진증(Hyperadrenocorticoism)의 임상증상이 전형적으로 하루에 나누어 투여하는 장기 약물 코르티코이드 요법 동안에 나타날 수 있다. 그것이 나타났다면 밤 동안의 상승된 코르티코이드치의 유지로 인한 주간 리듬의 혼란이 코르티코이드의 부작용 발현에 중요한 역할을 할 것 같다.
짧은 기간동안이라도 지속적으로 상승된 혈장 농도로부터 벗어나는 것은 부작용을 방지하는데 있어 도움이 될 수 있다. 전형적인 약물학적 용량의 코르티코이드 요법동안, 부신 피질에 의한 코르티솔의 생성 억제와 함께 ACTH 생성도 억제된다. 정상적인 HPA활성으로의 회복시간은 용량과 치료기간에 따라 다양하다. 이 기간동안 환자는 어떠한 스트레스가 있는 환경에도 민감하다. 아침 1회복용이 프레드니솔론(10mg)을 하루 4회에 나누어 매 6시간마다 복용하는 것보다는 상당히 적은 부신 억제를 나타낸다고 할지라도, 약물학적인 용량을 사용했을 경우 부신활성에 약간의 억제효과가 그 다음날까지 계속된다고 하는 증거가 있다. 게다가 어떠한 코르티코이드의 단 회 투여는 2일 또는 그 이상까지도 부신 피질의 억제가 보여진다. 메칠프레드니솔론, 히드로코르티손, 프레드니손, 프레드니솔론을 포함 하는 다른 르티코이드는 단기간 작용(1회 투여로 1¼에서 1½일 동안 부신피질억제가 나타남)으로 간주 되어지고 따라서 격일치료가 요망된다.
다음의 사항들은 격일 치료를 할 때 염두에 두어야만 한다.
1) 코르티코이드의 요법에 있어 기본적인 원칙과 적응증을 적용시켜야 한다. ADT의 장점이 코르티코이드의 무분별한 사용을 부추겨서는 안된다.
2) ADT는 장기 약물 코르티코이드 치료를 요망하는 환자에게 기본적으로 계획되어야만 하는 치료 기술이다.
3) 코르티코이드 요법의 적응증을 갖는 덜 심각한 질병에 있어서는 ADT가 초기에 사용될 수도 있다. 더욱 심각한 질환에서는 질병진행의 초기 조절을 위해 고용량을 하루에 나누어 투여하는 요법이 보통 요구되어질 것이다. 초기 억제 용량치는 만족할 만한 임상반응을 얻을 때까지 계속되어야만 하는데 보통 많은 알레르기 및 교원성 질환에 있어 4일에서 10일 동안이다.
특히 격일 요법의 지속적인 사용을 의도한다면, 가능한 한 짧은 기간동안의 초기 억제 용량기간을 지키는 것이 중요하다. 일단 통제가 이루어지면, 두 가지 경우가 가능하다.

① ADT로 전환하고 격일에 주어지는 코르티코이드의 양을 점진적으로 줄여간다.
② 질병 진행의 조절에 따라 가능한 한 빨리 최소 효과값으로 코르티코이드의 1일 용량을 감소시키고 난 후 격일 일정으로 변화시킨다. 이론적으로 ①과정이 더욱 바람직하다.4) ADT의 장점 때문에 오랜 기간 동안 매일 코르티코이드를 복용해온 환자에게 이러한 형태의 치료는 바람직하다(예를 들어 류마티스양 관절염). 이러한 환자는 이미 HPA축이 억제되어 있을 수 있으므로 ADT요법을 확립한다는 것이 어려울 수도 있고 항상 성공적인 것은 아니다. 그러나, 변경하려는 규칙적인 시도는 추천된다. 만약 어려움이 있다면 단지 매일 용량의 2배를 하는 것보다는 격일에 3배 심지어 4배로 투여하는 것이 바람직하다. 다시 환자가 통제가 되면, 이러한 용량을 최저로 감소하는 시도를 한다.
5) 위에서 언급했듯이 어떠한 코르티코이드는 부신기능을 오랫동안 억제하기 때문에 격일 요법으로 추천되지 않는다 (예를 들어 덱사메타손, 베타메타손).
6) 부신 피질의 최대 활성은 아침 2시에서 8시까지, 최저는 오후 4시에서 자정까지이다. 최대 활성의 시간대에 투여되었을 때(오전), 외인성 코르티코이드는 부신피질 활성을 가장 적게 억제한다.
7) ADT사용에 있어서, 모든 치료환경에서처럼, 각 환자에게 있어 개인화 되고 적절한 치료를 하는 것이 중요하다. 모든 환자에게 있어 증상의 완전한 통제는 불가능하다. ADT의 장점에 대한 설명은 환자에게 코르티코이드제를 투여하지 않은 날의 후반기에 나타날 수 있는 불안정한 증상을 이해하고 참아내는 데 도움을 줄 것이다. 만약 필요하다면 이 기간 동안 다른 증상 치료를 부가시키거나 증가시킬 수 있다.
8) 질병진행중 급성악화가 나타난다면 조절을 위하여 코르티코이드 용량을 하루에 나누어 완전히 억제하는 용량으로 돌아가는 것이 필요할 수도 있다. 일단 조절이 된 후에는 성립된 격일 요법으로 재시도할 수 있다.
9) 많은 코르티코이드 요법의 부작용들이 ADT로서 최소화될 수 있다고 할지라도, 모든 치료환경에서 그러하듯이 의사는 코르티코이드 치료가 생각되는 각 환자에 있어 치료 이익성과 위험성의 비율을 신중히 고려해야만 한다."'''
        }),
        "dur_info": json.dumps({
            "주의사항": '''1. 다음 환자에는 투여하지 말 것.

1) 이 약 또는 이 약 성분에 과민증 및 그 병력이 있는 환자
2) 유효한 항균제가 없는 감염증, 전신 진균 감염증 환자(면역기능 억제작용에 의해 감염증을 악화시킬
수 있다)
3) 단순포진, 대상포진, 수두 환자
4) 생백신 또는 약독 생백신을 투여중인 환자
5) 이 약은 유당을 함유하고 있으므로, 갈락토오스 불내성(galactose intolerance), Lapp 유당분해효소 결핍증(Lapp lactase deficiency) 또는 포도당-갈락토오스 흡수장애(glucose-galactose malabsorption) 등의 유전적인 문제가 있는 환자에게는 투여하면 안 된다.
2. 다음 환자에는 신중히 투여할 것.
1) 투여하지 않는 것을 원칙으로 하지만 다음 환자에는 특히 필요한 경우에 한하여 신중히 투여한다.
① 녹내장 환자(안압이 상승하여 녹내장이 악화될 수 있다)
② 결핵성 질환, 단순포진성 각막염 환자(면역 억제작용에 의해 증상을 악화시킬 수 있다)
③ 후낭하 백내장 환자(수정체선유의 영향으로 증상이 악화될 수 있다)
④ 전해질이상 환자, 고혈압 환자(전해질 대사작용에 의해 증상이 악화될 수 있다)
⑤ 혈전증 환자(혈액응고촉진작용에 의해 혈전증이 악화될 수 있다)
⑥ 최근 장문합술을 받은 환자(상처 치유 지연이 일어날 수 있다)
⑦ 급성심근경색을 일으킨 적이 있는 환자(심파열을 일으켰다는 보고가 있다)
⑧ 게실염 환자
⑨ 소화성 궤양 환자(소화관 보호작용을 감약시키고, 조직의 수복을 방해하므로 증상이 악화될 수 있다)
⑩ 정신병 환자(대뇌절연계의 신경전달물질에 영향을 주어 증상이 악화될 수 있다)
⑪ 중증 골다공증 환자(골형성 억제작용 등에 의해 골다공증이 악화될 수 있다)
2) 감염증이 있는 환자(면역기능 억제작용에 의해 감염증을 악화시킬 수 있다)
3) 당뇨병 환자(당신생작용에 의해 혈당치가 상승하여 당뇨병이 악화될 수 있다)
4) 골다공증 환자(골형성 억제작용 등에 의해 골다공증이 악화될 수 있다)
5) 신부전, 울혈성 심부전 환자(나트륨 저류작용으로 증상이 악화될 수 있다)
6) 갑상선기능저하증 환자(코르티코이드의 혈중 반감기가 연장되었다는 보고가 있다)
7) 지방간(간에 지방 침착이 증가하여 지방간이 악화될 수 있다)
8) 지방색전증 환자(코르티코이드 과량투여에 의해 지방 색전증이 나타났다는 보고가 있다)
9) 중증 근무력증 환자(사용초기에 일시적으로 증상이 악화될 수 있다)
10) 고령자
11) 뇌전증 환자
12) 궤양성 대장염(천공, 농양 또는 기타 화농성 감염증이 유발될 수 있는) 환자
13) 골다공증, 고혈압, 울혈성 심부전, 심각한 감정이상, 당뇨병, 결핵, 녹내장, 간장애, 신부전, 뇌전증,
소화성 궤양의 병력이 있는 환자(병이 악화될 수 있다)
''',
            "이상반응": '''3. 부작용
다음 증상이 나타날 수 있으므로 충분히 관찰하고, 이러한 증상이 나타나는 경우에는 적절한 처치를 한다.
1) 체액·전해질 : 부종, 나트륨저류, 칼륨손실, 체액저류, 저칼륨성 알칼리혈증, 감수성 환자에 있어서
울혈성 심부전, 고혈압 등이 나타날 수 있다.
2) 근·골격계 : 근무력증, 대퇴골 및 상완골 말단의 무균성 괴사, 스테로이드성 근병증, 근육실질의 손실, 장골의 병리적 골절, 골다공증, 척추압박골절, 관절통, 건파열(특히 아킬레스건) 등이 나타날 수 있다.
3) 소화기계 : ALT, AST, ALP 증가, 구역, 구갈, 구토, 위통, 식욕부진, 식욕항진, 천공 및 출혈의 가능성이 있는 소화성 궤양, 복부팽만감, 췌장염, 궤양성 식도염, 설사 등이 나타날 수 있다.
4) 피부 : 창상치유지연, 안면 홍반, 얇고 연약한 피부, 발한 이상, 점상출혈 및 반상출혈, 피부반응의
억제현상, 자반, 여드름, 다모, 탈모, 색소 침착 등이 나타날 수 있다.
5) 정신·신경계 : 치료 후 일어나는 유두부종(가뇌종양)을 수반한 두개내압 상승, 경련, 어지러움, 두통, 불면, 다행감, 우울증 등이 나타날 수 있다.
6) 내분비계 : 쿠싱증후군(월상안), 월경 이상, 소아의 성장억제, 잠재성 당뇨병 증상의 발현, 속발성 부 신기능부전과 뇌하수체 무반응(특히 외상, 수술, 질병시 등 스트레스시), 내당력 감소, 당뇨병 환자에
있어서 인슐린 또는 경구용 혈당강하제의 요구량 증가, 부신피질자극호르몬 분비 억제 등이 나타날 수 있다.
7) 눈 : 연용에 의해 안압항진, 녹내장, 후낭하 백내장, 곰팡이나 바이러스에 의한 눈의 2차 감염을 초래
할 수 있으므로 정기적으로 검사를 하는 것이 바람직하다. 중심성 장액성 맥락망막증 등에 의해 망막장애, 안구돌출 등이 나타날 수 있다.
8) 지질·단백질 대사 : 단백이화작용으로 인한 음성질소평형이 나타날 수 있다.
9) 면역계 : 면역계 장애, 정맥내 사용시 알레르기 반응, 드물게 쇽까지 일어날 수 있다.
10) 기타 : 코르티코이드 요법과 관련하여 경구와 비경구 투여시 다음과 같은 부작용이 보고된바 있다
- 두드러기, 기타 다른 알레르기성 반응, 아나필락시 반응, 과민성 반응
4. 일반적주의
1) 장기투여시 속발성 부신피질부전이 나타날 수 있으며, 투여 중지 후 수개월까지 계속될 수 있다. 장기 투여 후 코르티코이드를 갑자기 중지하면 급성부신부전, 가끔 발열, 두통, 식욕부진, 무력감, 근육통, 관절통, 쇽증상 등이 나타날 수 있으므로 점진적으로 감량하는 등 특히 주의하며, 금단증상이 나타난 경우에는 즉시 재투여 또는 증량한다. 장기 투여 중 외상, 수술, 감염 등의 스트레스 발생시 일시적으로 투여량을 증가해야 하며, 장기 투여 후 투여 중지상태인 경우에는 일시적으로 재투여해야 한다. 광질코르티코이드 분비가 손상을 받을 수 있으므로 염분 또는 광질코르티코이드를 병용하는 것이 바람직하다.
2) 장기 치료시 위험도를 고려한 후 치료를 시작해야 하며, 부작용은 투여량, 투여기간과 상관성을 나타내므로 최소 유효량을 되도록 단기간 투여하며 1일 1회 아침에 투여하거나 격일 투여가 권장된다.
3) 면역억제제를 투여중인 환자(소아)는 건강한 사람(소아)보다 감염되기 쉽다. 예를 들어 수두나 홍역은 면역억제제인 코르티코이드를 투여한 환자에서 더 심각하거나 심지어 치명적인 결과를 일으킬 수 있다. 이러한 질환을 앓아 본적이 없는 성인 및 소아의 경우 이러한 것에 노출되지 않도록 특히 주의한다. 만일 수두에 노출되면 3일-10일 이내 수두대상포진 면역글로불린(VZIG), 홍역에 노출되면 면역글로불린(IG) 같은 예방처치가 필요하다. 수두가 발생되면 항바이러스약물 사용이 고려된다.
4) 코르티코이드 요법을 받는 환자는 생백신을 투여 받으면 안되며, 신경학적 합병증의 가능성과 항체반응의 결핍으로 인하여 특히 고용량으로 코르티코이드를 투여중인 환자는 기타의 예방 접종도 하지 않아야 한다.
5) 코르티코이드를 투여하면 감염증의 증상을 때때로 불현성화시킬 수 있으며 사용 중 또 다른 감염을 발생할 수 있다. 코르티코이드 투여 중에는 감염을 국소화시키는 능력과 저항력이 저하될 수 있다.
6) 활동성 결핵환자에 이 약의 투여는 전격성, 파종성 결핵에 한정되며 적절한 항결핵요법제와 병용투여한다.
7) 잠복성 결핵 환자 또는 튜베르쿨린 반응 양성 환자에게 코르티코이드를 투여할 경우 결핵이 재활성화될 수 있으므로 세밀한 관찰이 필요하며 장기 연용할 경우에는 예방적 화학요법을 받아야 한다.
8) 임상시험에서 코르티코이드가 다발성 경화증의 급성악화를 신속하게 경감시키는데 유효한 것으로 나타났으나 근본적인 치료를 하는 것으로 볼 수 없다.
9) 히드로코르티손 또는 코르티손의 평균용량 또는 그 이상을 사용할 경우 혈압상승, 염과 수분의 저류, 칼륨배설의 증가를 일으킬 수 있으나 과잉 투여시 이외에는 합성유도체로 인한 이런 작용이 나타날 염려가 없다. 음식물 섭취시 염제한과 칼륨보충이 필요할 수 있다. 모든 코르티코이드는 칼슘배설을 증가시킨다.
10) 시판 후 사용 중 혈액암과 고형암을 포함한 악성종양 환자에서 전신 코르티코스테로이드 단독투여 또는 다른 화학요법제와의 병용투여 후 종양용해증후군(TLS)이 보고되었다. 이러한 종양용해증후군의 위험이 높은 환자는 종양의 증식률과 종양 부담(tumor burden)이 높고 세포독성 항암제에 높은 민감도를 가진 환자로서 주의깊게 모니터링하고 적절한 조치를 취해야 한다.
11) 특히, 이 약 투여 중에 수두 또는 홍역에 감염되면, 치명적인 경과에 이를 수 있으므로, 다음 주의가 필요하다.
(1) 이 약 투여 전에 수두 또는 홍역의 병력과 예방접종의 유무를 확인한다.
(2) 수두 또는 홍역의 병력이 없는 환자에 대해서는 수두 또는 홍역에의 감염을 최대한 방지하여 충분한 배려와 관찰을 한다. 감염이 의심스러운 경우와 감염된 경우에는 즉시 진찰을 받아 지도하고, 적절한 처치를 한다.
(3) 수두 또는 홍역의 병력과 예방접종을 받은 적이 있는 환자에서도 이 약 투여 중에 수두 또는 홍역이 나타 날 가능성이 있으므로 유의한다.

''',
            "상호작용": '''5. 상호작용
1) 다형성 심실 빈맥을 일으킬 수 있는 약물(아스테미졸, 베프리딜, 에리스로마이신 IV, 할로판트린, 펜타미딘, 스파르플록사신, 빈카민, 설토프리드)과 병용투여하지 않는다.
2) 다형성 심실 빈맥을 일으킬 수 있는 항부정맥제(아미오다론, 디소피라미드, 퀴니딘, 소탈올)와의 병용에 의해 서맥, QT 간격 연장, 저칼륨혈증 등이 나타나 부정맥을 일으킬 수 있으므로 신중히 투여하고 심실 빈맥이 나타나면 항부정맥제 투여를 중지한다.
3) 바르비탈계 약물(페노바르비탈), 페니토인, 리팜피신, 카르바마제핀, 프리미돈, 아미노글루테치미드, 리파부틴과 병용투여에 의해 이 약의 작용이 감소될 수 있으므로 병용투여시 용량에 주의한다.
4) 비스테로이드성 소염제와 병용투여시 위장관 궤양의 위험을 증가시킬 수 있으며, 아스피린과 병용투여시 아스피린의 신청소율을 증가시켜 살리실산염의 혈중 농도를 감소시키거나 이 약을 중단했을 때 살리실산염의 독성을 증가시킬 수 있으므로 용량에 주의한다. 특히 저프로트롬빈혈증 환자에서 이 약과 아스피린을 병용투여시 주의한다.
5) 항응고제, 혈당강하제의 경우 코르티코이드와의 병용투여에 의해 그 작용이 약화될 수 있으므로 용량조절이 필요하다.
6) 이뇨제(칼륨보존성 이뇨제는 제외), 암포테리신 B, 카르베노졸론, 완화제와의 병용에 의해 저칼륨혈증이 나타날 수 있으므로, 자주 혈중 칼륨농도를 검사하고 병용투여시 용량에 주의한다.
7) 디기탈리스 배당체와 병용투여시 부정맥, 저칼륨혈증과 관련된 독성이 증가할 수 있으므로 혈중 칼륨농도를 검사하고 경우에 따라서는 심전도 검사를 실시한다.
8) 이소니아지드와 병용투여시 이소니아지드의 혈중농도가 감소하므로 용량조절이 필요하다.
9) 제산제는 당질코르티코이드의 위장관 흡수를 방해하므로 투여간격을 2시간 이상으로 한다.
10) 혈압강하제와 병용투여시 혈압강하효과를 감소시킬 수 있다(나트륨 증가로 수분정체 위험이 있다).
11) 알파인터페론과 병용투여시 인터페론의 활성을 억제할 수 있다.
12) 사이클로스포린과 병용투여시 사이클로스포린의 혈중농도를 상승시켜 경련이 발생했다는 보고가 있으므로 병용투여시 용량에 주의한다.
13) 케토코나졸, 에리스로마이신, 트롤레안도마이신, 에스트로겐은 이 약의 작용을 증가시킬 수 있으므로 병용투여시 용량조절에 주의한다.
14) 비탈분극성 근이완제(브롬화판크로니움 등)와 병용에 의해 근이완 작용이 감소 또는 증가될 수 있으므로 병용투여시 용량에 주의한다.
15) ACE억제제와의 병용에 의해 혈액상 변화 발생위험이 증가할 수 있다.
16) 클로로퀸, 히드록시클로로퀸과의 병용에 의해 근병증, 심근증 발생위험이 증가할 수 있다.
17) 소마트로핀과의 병용에 의해 소마트로핀의 효과를 감소시킬 수 있다.
'''
        }),
        "created_at": datetime.now(UTC)
    },
    {
        "id": 5,
        "name": "씨투스정50mg",
        "details": json.dumps({
            "성분": "미결정셀룰로오스, 스테아르산마그네슘, 오파드라이 II",
            "용법용량": '''성인 : 프란루카스트수화물로서 1회 50mg을 1일 2회 아침, 저녁 식후 경구투여한다.
증상에 따라 적절히 증감한다''',
            "효능효과": "감기의 제증상(콧물, 코막힘, 재채기, 인후통, 기침, 가래, 오한, 발열, 두통, 관절통, 근육통)의 완화"
        }),
        "dur_info": json.dumps({
            "주의사항": '''3. 일반적 주의 
 1) 이 약은 기관지확장제, 스테로이드제 등과는 달리 이미 일어나고 있는 천식발작을 경감시키는 약물이 아니므로, 이것을 환자에게 충분히 설명할 필요가 있다.
 2) 이 약의 투여중에 대발작이 일어난 경우는 기관지확장제 또는 스테로이드제를 투여할 필요가 있다.
 3) 장기 스테로이드요법을 받고 있는 환자 중, 이 약의 투여에 의해 스테로이드를 감량하는 경우에는 충분한 관리하에 천천히 한다.
 4) 이 약의 투여에 의해 스테로이드 유지량을 감량한 환자 중 이 약의 투여를 중지하는 경우에는 원질환 재발의 우려가 있으므로 주의한다.
 5) 이 약을 포함하여 류코트리엔길항제 사용시에 Churg-Strauss 증후군과 같은 혈관염이 나타났다는 보고가 있다. 이들 증상은 대체로 경구스테로이드제의 감량.중지시에 나타나고 있다. 이 약 사용시는 호산구수, 혈관염증상(저림, 사지약화, 발열, 관절통, 폐의 침윤 등) 등의 추이에 주의한다.
 6) 다른 류코트리엔 길항제를 투여 받은 환자에서 인과관계는 명확하지 않으나 우울증, 자살생각, 자살 및 공격적 행동 등의 정신 증상이 보고되었으므로 이 약을 투여한 후 환자의 상태를 주의 깊게 관찰해야 한다.
 7) 이 약의 투여에 의해 효과가 나타나지 않을 경우에는, 장기간에 걸쳐 투여하지 않도록 주의한다.
5. 임부 및 수유부에 대한 투여
  임부 또는 임신하고 있을 가능성이 있는 여성에게는, 치료상의 유익성이 위험성을 상회한다고 판단될 경우에만 투여한다(임신중의 투여에 관한 안전성은 확립되어 있지 않다.).

6. 소아에 대한 투여
  저체중출생아, 신생아, 영아 또는 소아에 대한 안전성은 확립되어 있지 않다(사용경험이 많지 않다.).

7. 고령자에 대한 투여
  일반적으로 고령자는 생리기능이 저하되어 있으므로 감량(예를 들어, 1회 성인 용량의 1/2을 1일 2회)하는 등 주의한다.

8. 보관 및 취급상의 주의사항 
 1) 어린이의 손이 닿지 않는 곳에 보관한다.
 2) 다른 용기에 바꾸어 넣는 것은 사고원인이 되거나 품질 유지면에서 바람직하지 않으므로 이를 주의한다.","기밀용기, 실온(1-30℃)보관",,Pranlukast Hydrate　프란루카스트수화물　50mg,,,https://common.health.kr/shared/images/sb_photo/big3/201603220001001.jpg,645702760,2016032200010,"- 처방에 따라 규칙적으로 투여해야 이 약의 효과가 잘 나타나요.
- 증상이 개선되더라도 전문가와 상의없이 투약을 중단하지 마세요.
- 급성 천식 발작 시에는 이 약을 투여하지 마세요.
- 발진, 발적, 가려움증 등의 증상이 나타날 경우 전문가와 상의하세요.
- 치료기간 동안 환자의 행동에 변화가 있는지 주의 깊게 관찰하세요.1. 다음 환자에는 투여하지 말 것.

  1) 이 약 또는 이 약의 구성성분에 과민반응 환자
   2) 이 약은 유당을 함유하고 있으므로, 갈락토오스 불내성(galactose intolerance), Lapp 유당분해효소 결핍증(Lapp lactase deficiency) 또는 포도당-갈락토오스 흡수장애(glucose-galactose malabsorption) 등의 유전적인 문제가 있는 환자에게는 투여하면 안 된다.

''',
            "이상반응": '''2. 이상반응
 1) 쇼크 : 쇼크 또는 아나필락시스모양 증상(빈도불명)이 나타날 수 있으므로 주의깊게 관찰한다. 혈압저하, 의식장애, 호흡곤란, 발진 등의 증상이 나타나면, 투여를 중지하고 적절한 처치를 한다.
 2) 혈액계 : 백혈구감소(초기증상 : 발열, 인후통, 전신권태감 등), 혈소판감소(초기증상 : 자반, 코피, 치육출혈 등의 출혈경향)가 나타날 수 있으므로, 이러한 증상이 나타난 경우에는 투여를 중지한다.
 3) 간장 : 황달, AST, ALT의 상승 등을 동반하는 간기능장애가 나타날 수 있으므로, 관찰을 충분히 하여 이러한 경우에는 투여를 중지하고 적절한 처치를 한다. 때때로 빌리루빈 상승, 드물게 ALP 상승 등이 나타날 수 있다.
 4) 호흡기계 : 발열, 기침, 호흡곤란, 흉부 X선 비정상, 호산구증가 등을 수반한 간질성 폐렴과 호산구성 폐렴(0.02%)이 나타날 수 있다. 이러한 증상이 발현될 경우에는 투약을 중지하고 부신피질호르몬 투여와 같은 적절한 처치를 한다.
 5) 근골격계 : 횡문근융해가 나타날 수 있다. 근육통, 무력감, CK(CPK) 상승, 마이오글로빈 상승 등의 증상이 발현될 경우에는 투여를 중지하고 적절한 처치를 한다. 또한, 횡문근융해로 인한 급성신장장애의 발생에도 주의해야 한다. 드물게 관절통이 나타날 수 있다.
 6) 과민반응 : 때때로 발진, 두드러기, 드물게 가려움, 다형삼출성홍반 등이 나타날 수 있으므로 이상이 나타나는 경우에는 투여를 중지하는 등 적절한 처치를 한다.
 7) 정신신경계 : 진전, 경련, 흥분, 불안, 때때로 두통, 졸음, 어지러움, 드물게 불면, 저림, 미각이상이 나타날 수 있다.
 8) 소화기계 : 때때로 구역, 복통, 위부불쾌감, 설사, 드물게 구토, 속쓰림, 식욕부진, 변비, 복부팽만감, 구내염, 혀염, 혀마비가 나타날 수 있다.
 9) 순환기계 : 드물게 부정맥(빈맥.심방세동.기외수축 등), 심계항진, 홍조가 나타날 수 있다.
 10) 비뇨기계 : 드물게 단백뇨, 요잠혈, 빈뇨 빈도불명의 요량감소 및 배뇨장애가 나타날 수 있다. 
 11) 기타 : 경직, 무력, 체중증가, 유루증, 수전증, 객담증가, 기침, 위장염, 탈모, 월경불순, 드물게 흉부교액감, 부종, 권태감, 트리글리세라이드 상승, 출혈, 호산구증가증, 인두불쾌감, 구갈, 이명이 나타날 수 있다.
 12) 기관지천식에 사용시
  (1) 국외(일본)에서 승인시 조사부터 시판후 조사까지 이상반응집계의 대상이 된 4963례중 174례(3.5%)에서 216건의 이상반응(임상검사치 이상 포함)이 나타났다. 주요한 것은 발진.가려움이 30례(0.6%), 복통.위부불쾌감이 29례(0.6%), 설사 19례(0.4%), 구역 15례(0.3%), AST.ALT 상승 등의 간기능이상이 17례(0.3%), 빌리루빈 상승이 7례(0.1%) 등이다. 
  (2) 국내에서 6년 동안 3,271례를 대상으로 실시한 시판후 조사 결과 160례(4.9%)에서 이상반응이 보고되었고 주된 이상반응은 소화불량 34례(1.0%), 가려움 30례(0.9%) 등이었다.
 13) 알레르기성 비염에 사용시
  (1) 국외(일본)에서 승인시 조사부터 시판후 조사까지 이상반응집계의 대상이 된 4277례중 200례(4.7%)에서 258건의 이상반응(임상검사치 이상 포함)이 나타났다. 주요한 것은 설사 42례(1.0%), 복통.위부불쾌감 35례(0.8%), 발진.가려움 24례(0.6%), 졸음 17례(0.4%), 구역 13례(0.3%), AST.ALT 상승 등의 간기능이상 8례(0.2%), 빌리루빈 상승 8례(0.2%) 등 이다. 
  (2) 국내에서 4년동안 696례를 대상으로 실시한 시판후조사 결과 4례(0.6%)의 이상반응이 보고되었고, 주된 것은 가려움 2례(0.3%)였다.
''',
            "상호작용": '''1) 이 약은 in vitro 시험에서 CYP3A4에 의해 대사되어, 이들 약물의 대사를 경합적으로 저해하므로 주로 CYP3A4에 의해 대사되는 약물과 병용투여시 주로 CYP3A4에 의해 대사되는 약물의 혈중농도가 상승할 가능성이 있다.
 2) 이 약의 대사는 in vitro 시험 및 in vivo 시험에서 CYP3A4를 저해하는 약물에 의한 이 약의 대사가 저해된다는 보고가 있으므로 CYP3A4를 저해하는 약물(이트라코나졸, 에리트로마이신 등)과 병용투여시 이 약의 혈중농도가 상승할 가능성이 있다.
'''
        }),
        "created_at": datetime.now(UTC)
    }
    
]

# 사용자-약물 연결 데이터
sample_user_medications = [
    {
        "user_id": 1,
        "medication_id": 1,
        "created_at": datetime.now(UTC)
    },
    {
        "user_id": 1,
        "medication_id": 2,
        "created_at": datetime.now(UTC)
    }
]

async def create_test_database():
    # 데이터베이스 엔진 생성
    engine = create_async_engine(
        DATABASE_URL,
        echo=True,
        connect_args={"check_same_thread": False}  # SQLite 동시성 이슈 해결
    )
    
    # 기존 테이블 삭제 후 새로 생성
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
        await conn.run_sync(Base.metadata.create_all)
    
    # 세션 팩토리 생성
    async_session = sessionmaker(
        engine,
        class_=AsyncSession,
        expire_on_commit=False  # 세션 커밋 후에도 객체 사용 가능
    )
    
    async with async_session() as session:
        async with session.begin():  # 트랜잭션 컨텍스트 매니저 사용
            try:
                # 사용자 데이터 삽입
                for user_data in sample_users:
                    user = User(**user_data)
                    session.add(user)
                await session.flush()  # 중간 플러시 추가
                
                # 약물 데이터 삽입
                for med_data in sample_medications:
                    medication = Medication(**med_data)
                    session.add(medication)
                await session.flush()  # 중간 플러시 추가
                
                # 사용자-약물 연결 데이터 삽입
                for um_data in sample_user_medications:
                    user_medication = UserMedication(**um_data)
                    session.add(user_medication)
                
                print("테스트 데이터베이스가 성공적으로 생성되었습니다.")
                
            except Exception as e:
                print(f"오류 발생: {str(e)}")
                raise
    
    await engine.dispose()  # 엔진 정리

if __name__ == "__main__":
    asyncio.run(create_test_database())